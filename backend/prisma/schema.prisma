// Prisma schema for SMIF Gestao

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  name             String
  passwordHash     String
  isActive         Boolean        @default(true)
  executiveHidePii Boolean        @default(false)
  loginFailedCount Int            @default(0)
  lockUntil        DateTime?
  localityId       String?
  specialtyId      String?
  eloRoleId        String?        // Responsável por este elo (ex: Psicologia a nível Brasil)
  flagsJson        Json?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  locality         Locality?      @relation(fields: [localityId], references: [id])
  specialty        Specialty?     @relation(fields: [specialtyId], references: [id])
  eloRole          EloRole?      @relation(fields: [eloRoleId], references: [id])
  roles            UserRole[]
  moduleAccessOverrides UserModuleAccessOverride[]
  refreshTokens    RefreshToken[]
  assignedTasks    TaskInstance[] @relation("TaskAssignee")
  taskComments     TaskComment[]  @relation("TaskCommentAuthor")
  taskCommentReads TaskCommentRead[]
  createdActivities Activity[]    @relation("ActivityCreator")
  activityComments ActivityComment[] @relation("ActivityCommentAuthor")
  activityCommentReads ActivityCommentRead[]
  signedActivityReports ActivityReport[] @relation("ActivityReportSigner")
  auditLogs        AuditLog[]
  meetingParticipations MeetingParticipant[]
  biSurveyImportBatches BiSurveyImportBatch[]
}

model UserModuleAccessOverride {
  id        String   @id @default(cuid())
  userId    String
  resource  String
  enabled   Boolean
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource])
  @@index([userId])
  @@index([resource])
}

model Role {
  id                     String           @id @default(cuid())
  name                   String           @unique
  description            String?
  isSystemRole           Boolean          @default(false)
  wildcard               Boolean          @default(false)
  flagsJson              Json?
  constraintsTemplateJson Json?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  permissions            RolePermission[]
  users                  UserRole[]
}

model Permission {
  id          String           @id @default(cuid())
  resource    String
  action      String
  scope       PermissionScope
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  roles       RolePermission[]

  @@unique([resource, action, scope])
}

model RolePermission {
  id           String      @id @default(cuid())
  roleId       String
  permissionId String

  role         Role        @relation(fields: [roleId], references: [id])
  permission   Permission  @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
}

model UserRole {
  id      String @id @default(cuid())
  userId  String
  roleId  String

  user    User   @relation(fields: [userId], references: [id])
  role    Role   @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Locality {
  id                         String          @id @default(cuid())
  code                       String          @unique
  name                       String
  commandName                String?
  commanderName              String?
  individualMeetingDate      DateTime?       // Data da Reunião Individual
  visitDate                  DateTime?       // Data da Visita da CIPAV
  recruitsFemaleCountCurrent Int?
  notes                      String?
  createdAt                  DateTime        @default(now())
  updatedAt                  DateTime        @updatedAt

  users                      User[]
  taskInstances              TaskInstance[]
  activities                 Activity[]
  meetings                   Meeting[]
  recruitsHistory            RecruitsHistory[]
  notices                    Notice[]
  elos                       Elo[]
  documents                  DocumentAsset[]
  checklistItemStatuses      ChecklistItemStatus[]
  kpiValues                  KpiValue[]
  auditLogs                  AuditLog[]
}

model Activity {
  id            String        @id @default(cuid())
  title         String
  description   String?
  localityId    String?
  eventDate     DateTime?
  status        ActivityStatus @default(NOT_STARTED)
  reportRequired Boolean      @default(false)
  createdById   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  locality      Locality?     @relation(fields: [localityId], references: [id])
  createdBy     User?         @relation("ActivityCreator", fields: [createdById], references: [id])
  report        ActivityReport?
  documents     DocumentAsset[]
  visitScheduleItems ActivityVisitScheduleItem[]
  comments      ActivityComment[]
  commentReads  ActivityCommentRead[]

  @@index([localityId])
  @@index([status])
  @@index([eventDate])
}

model ActivityVisitScheduleItem {
  id               String   @id @default(cuid())
  activityId       String
  title            String
  startTime        String
  durationMinutes  Int
  location         String
  responsible      String
  participants     String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  activity         Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId, startTime])
}

model ActivityReport {
  id                        String   @id @default(cuid())
  activityId                String   @unique
  date                      DateTime
  location                  String
  responsible               String
  missionSupport            String
  introduction              String
  missionObjectives         String
  executionSchedule         String
  activitiesPerformed       String
  participantsCount         Int
  participantsCharacteristics String
  conclusion                String
  city                      String
  closingDate               DateTime
  signaturePayloadHash      String?
  signatureHash             String?
  signatureAlgorithm        String?
  signatureVersion          Int?
  signedAt                  DateTime?
  signedById                String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  activity                  Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  signedBy                  User?    @relation("ActivityReportSigner", fields: [signedById], references: [id], onDelete: SetNull)
  photos                    ActivityReportPhoto[]
}

model ActivityReportPhoto {
  id          String   @id @default(cuid())
  reportId    String
  fileName    String
  fileUrl     String
  storageKey  String?
  mimeType    String?
  fileSize    Int?
  checksum    String?
  createdAt   DateTime @default(now())

  report      ActivityReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

model Specialty {
  id         String         @id @default(cuid())
  name       String         @unique
  color      String?
  icon       String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  users      User[]
  templates  TaskTemplate[]
  notices    Notice[]
  checklists Checklist[]
  kpiValues  KpiValue[]
}

model Phase {
  id        String      @id @default(cuid())
  name      PhaseName   @unique
  displayName String?
  order     Int
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  templates TaskTemplate[]
  checklists Checklist[]
}

model TaskTemplate {
  id                     String        @id @default(cuid())
  title                  String
  description            String?
  phaseId                String
  specialtyId            String?
  eloRoleId              String?
  appliesToAllLocalities Boolean
  reportRequiredDefault  Boolean
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  phase        Phase         @relation(fields: [phaseId], references: [id])
  specialty    Specialty?    @relation(fields: [specialtyId], references: [id])
  eloRole      EloRole?     @relation(fields: [eloRoleId], references: [id])
  instances    TaskInstance[]
  checklistItems ChecklistItem[]

  @@index([phaseId])
}

model TaskInstance {
  id              String        @id @default(cuid())
  taskTemplateId  String
  localityId      String
  meetingId       String?
  eloRoleId       String?
  dueDate         DateTime
  status          TaskStatus
  priority        TaskPriority
  progressPercent Int
  assignedToId    String?
  assignedEloId   String?
  assigneeType    TaskAssigneeType?
  externalAssigneeName String?
  externalAssigneeRole String?
  reportRequired  Boolean
  blockedByIdsJson Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  taskTemplate    TaskTemplate  @relation(fields: [taskTemplateId], references: [id])
  locality        Locality      @relation(fields: [localityId], references: [id])
  meeting         Meeting?      @relation(fields: [meetingId], references: [id])
  eloRole         EloRole?      @relation(fields: [eloRoleId], references: [id])
  assignedTo      User?         @relation("TaskAssignee", fields: [assignedToId], references: [id])
  assignedElo     Elo?          @relation("TaskAssigneeElo", fields: [assignedEloId], references: [id])
  reports         Report[]
  comments        TaskComment[]
  commentReads    TaskCommentRead[]

  @@index([localityId])
  @@index([localityId, dueDate, status])
  @@index([meetingId])
  @@index([eloRoleId])
  @@index([assignedEloId])
}

model Posto {
  id         String   @id @default(cuid())
  code       String   @unique  // ex: SGT, CAP, SOLD
  name       String   // ex: Sargento, Capitão, Soldado
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Meeting {
  id              String        @id @default(cuid())
  datetime        DateTime
  scope           String        @default("")  // texto livre: o que será tratado na reunião
  status          MeetingStatus
  meetingType     MeetingType   @default(PRESENCIAL)
  meetingLink     String?
  agenda          String?
  localityId      String?
  participantsJson Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  locality        Locality?     @relation(fields: [localityId], references: [id])
  participants    MeetingParticipant[]
  tasks           TaskInstance[]
  decisions       MeetingDecision[]
  documents       DocumentAsset[]
}

model MeetingParticipant {
  id        String   @id @default(cuid())
  meetingId String
  userId    String

  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([meetingId, userId])
  @@index([meetingId])
  @@index([userId])
}

model MeetingDecision {
  id         String   @id @default(cuid())
  meetingId  String
  text       String
  createdAt  DateTime @default(now())

  meeting    Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
}

model Report {
  id             String       @id @default(cuid())
  taskInstanceId String
  fileName       String
  fileUrl        String
  storageKey     String?
  mimeType       String?
  fileSize       Int?
  checksum       String?
  approved       Boolean      @default(false)
  createdAt      DateTime     @default(now())

  taskInstance   TaskInstance @relation(fields: [taskInstanceId], references: [id])
}

model DocumentAsset {
  id          String           @id @default(cuid())
  title       String
  category    DocumentCategory
  subcategoryId String?
  sourcePath  String
  fileName    String
  fileUrl     String
  storageKey  String?
  mimeType    String?
  fileSize    Int?
  checksum    String?
  localityId  String?
  activityId  String?
  meetingId   String?
  tagsJson    Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  locality    Locality?        @relation(fields: [localityId], references: [id])
  subcategory DocumentSubcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  activity    Activity?        @relation(fields: [activityId], references: [id], onDelete: SetNull)
  meeting     Meeting?         @relation(fields: [meetingId], references: [id], onDelete: SetNull)
  content     DocumentContent?
  links       DocumentLink[]

  @@index([category, localityId, createdAt])
  @@index([category, subcategoryId, createdAt])
  @@index([activityId])
  @@index([meetingId])
}

model DocumentSubcategory {
  id          String           @id @default(cuid())
  category    DocumentCategory
  name        String
  parentId    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  parent      DocumentSubcategory?  @relation("DocumentSubcategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    DocumentSubcategory[] @relation("DocumentSubcategoryTree")
  documents   DocumentAsset[]

  @@unique([category, parentId, name])
  @@index([category, createdAt])
  @@index([category, parentId, createdAt])
}

model DocumentContent {
  id          String              @id @default(cuid())
  documentId  String              @unique
  parseStatus DocumentParseStatus @default(PENDING)
  textContent String?
  parsedAt    DateTime?
  metadataJson Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  document    DocumentAsset       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([parseStatus, parsedAt])
}

model DocumentLink {
  id          String             @id @default(cuid())
  documentId  String
  entityType  DocumentLinkEntity
  entityId    String
  label       String?
  createdAt   DateTime           @default(now())

  document    DocumentAsset      @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, entityType, entityId])
  @@index([documentId, entityType])
  @@index([entityType, entityId])
}

model TaskComment {
  id             String   @id @default(cuid())
  taskInstanceId String
  authorId       String
  text           String
  createdAt      DateTime @default(now())

  taskInstance   TaskInstance @relation(fields: [taskInstanceId], references: [id], onDelete: Cascade)
  author         User         @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskInstanceId, createdAt])
  @@index([authorId])
}

model TaskCommentRead {
  id             String   @id @default(cuid())
  taskInstanceId String
  userId         String
  seenAt         DateTime @default(now())
  updatedAt      DateTime @updatedAt

  taskInstance   TaskInstance @relation(fields: [taskInstanceId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskInstanceId, userId])
  @@index([userId, seenAt])
}

model ActivityComment {
  id         String   @id @default(cuid())
  activityId String
  authorId   String
  text       String
  createdAt  DateTime @default(now())

  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  author     User     @relation("ActivityCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([activityId, createdAt])
  @@index([authorId])
}

model ActivityCommentRead {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  seenAt     DateTime @default(now())
  updatedAt  DateTime @updatedAt

  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([activityId, userId])
  @@index([userId, seenAt])
}

model Kpi {
  id         String         @id @default(cuid())
  key        String         @unique
  label      String
  visibility KpiVisibility  @default(DEFAULT)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  values     KpiValue[]
}

model KpiValue {
  id          String      @id @default(cuid())
  kpiId       String
  date        DateTime
  value       Float
  localityId  String?
  specialtyId String?
  createdAt   DateTime    @default(now())

  kpi         Kpi         @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  locality    Locality?   @relation(fields: [localityId], references: [id])
  specialty   Specialty?  @relation(fields: [specialtyId], references: [id])

  @@index([kpiId, date])
}

model Notice {
  id           String          @id @default(cuid())
  title        String
  body         String
  localityId   String?
  specialtyId  String?
  dueDate      DateTime?
  priority     NoticePriority @default(MEDIUM)
  pinned       Boolean         @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  locality     Locality?      @relation(fields: [localityId], references: [id])
  specialty    Specialty?     @relation(fields: [specialtyId], references: [id])

  @@index([localityId, specialtyId, dueDate])
}

model Checklist {
  id          String      @id @default(cuid())
  title       String
  phaseId     String?
  specialtyId String?
  eloRoleId   String?     // Elo responsável por acompanhar este checklist (ex: Psicologia)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  phase       Phase?      @relation(fields: [phaseId], references: [id])
  specialty   Specialty?  @relation(fields: [specialtyId], references: [id])
  eloRole     EloRole?    @relation(fields: [eloRoleId], references: [id])
  items       ChecklistItem[]
}

model ChecklistItem {
  id             String      @id @default(cuid())
  checklistId    String
  title          String
  taskTemplateId String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  checklist      Checklist   @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  taskTemplate   TaskTemplate? @relation(fields: [taskTemplateId], references: [id])
  statuses       ChecklistItemStatus[]

  @@index([checklistId])
  @@index([taskTemplateId])
}

model ChecklistItemStatus {
  id              String               @id @default(cuid())
  checklistItemId String
  localityId      String
  status          ChecklistItemStatusType
  updatedAt       DateTime             @updatedAt

  checklistItem   ChecklistItem        @relation(fields: [checklistItemId], references: [id], onDelete: Cascade)
  locality        Locality             @relation(fields: [localityId], references: [id])

  @@unique([checklistItemId, localityId])
  @@index([localityId])
}

model EloRole {
  id        String   @id @default(cuid())
  code      String   @unique  // ex: PSICOLOGIA, SSO, JURIDICO, CPCA, GRAD_MASTER
  name      String   // ex: Psicologia, SSO, Jurídico
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  elos            Elo[]
  taskInstances   TaskInstance[]
  taskTemplates   TaskTemplate[]
  users           User[]
  checklists      Checklist[]
}

model Elo {
  id         String   @id @default(cuid())
  localityId String
  eloRoleId  String
  name       String
  rank       String?
  phone      String?
  email      String?
  om         String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  locality  Locality  @relation(fields: [localityId], references: [id])
  eloRole   EloRole   @relation(fields: [eloRoleId], references: [id])
  assignedTasks TaskInstance[] @relation("TaskAssigneeElo")

  @@index([localityId, eloRoleId])
}

model RecruitsHistory {
  id                  String    @id @default(cuid())
  localityId          String
  date                DateTime
  recruitsFemaleCount Int
  turnoverCount       Int
  createdAt           DateTime  @default(now())

  locality            Locality  @relation(fields: [localityId], references: [id])

  @@unique([localityId, date])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  localityId String?
  resource  String
  action    String
  entityId  String?
  diffJson  Json?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])
  locality  Locality? @relation(fields: [localityId], references: [id])

  @@index([createdAt, resource, entityId])
  @@index([localityId])
}

model BiSurveyImportBatch {
  id            String          @id @default(cuid())
  fileName      String
  format        BiImportFormat
  sheetName     String?
  totalRows     Int
  insertedRows  Int
  duplicateRows Int
  invalidRows   Int
  importedById  String?
  importedAt    DateTime        @default(now())

  importedBy    User?           @relation(fields: [importedById], references: [id], onDelete: SetNull)
  responses     BiSurveyResponse[]

  @@index([importedAt])
  @@index([importedById, importedAt])
}

model BiSurveyResponse {
  id                 String              @id @default(cuid())
  batchId            String?
  submittedAt        DateTime?
  sufferedViolenceRaw String?
  sufferedViolence   Boolean?
  violenceTypes      String[]            @default([])
  postoGraduacao     String?
  om                 String?
  posto              String?
  autodeclara        String?
  extraColumn        String?
  rawPayload         Json?
  sourceRow          Int?
  sourceHash         String              @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  batch              BiSurveyImportBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([submittedAt])
  @@index([sufferedViolence, om])
  @@index([om, postoGraduacao])
  @@index([posto])
  @@index([autodeclara])
  @@index([batchId])
}

enum TaskStatus {
  NOT_STARTED
  STARTED
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum DocumentCategory {
  GENERAL
  MISSION
  PRESENTATION
  HISTORY
  RESEARCH
  SMIF
  VISUAL_IDENTITY
}

enum DocumentParseStatus {
  PENDING
  EXTRACTED
  PARTIAL
  FAILED
  NOT_SUPPORTED
}

enum DocumentLinkEntity {
  TASK_INSTANCE
  TASK_TEMPLATE
  ACTIVITY
  MEETING
  ELO
  LOCALITY
}

enum TaskAssigneeType {
  USER
  ELO
  LOCALITY_COMMAND
  LOCALITY_COMMANDER
}

enum PhaseName {
  PREPARACAO
  EXECUCAO
  ACOMPANHAMENTO
}

enum MeetingType {
  ONLINE
  PRESENCIAL
}

enum MeetingStatus {
  PLANNED
  HELD
  CANCELLED
}

enum KpiVisibility {
  DEFAULT
  EXECUTIVE
}

enum NoticePriority {
  LOW
  MEDIUM
  HIGH
}

enum ChecklistItemStatusType {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum PermissionScope {
  NATIONAL
  LOCALITY
  SPECIALTY
  LOCALITY_SPECIALTY
  OWN
}

enum ActivityStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
  CANCELLED
}

enum BiImportFormat {
  CSV
  XLSX
}
